<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistem Informasi SSJ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- 1. Placeholder untuk sidebar -->
        <aside id="sidebar-placeholder" class="w-64 bg-white shadow-md flex flex-col"></aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 sm:p-10 overflow-y-auto">
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
            </header>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div><p class="text-sm font-medium text-gray-500">Jumlah Uang Kas</p><p id="total-kas" class="text-2xl font-bold text-gray-800">Memuat...</p></div>
                    <div class="bg-blue-100 p-3 rounded-full"><svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div><p class="text-sm font-medium text-gray-500">Jumlah Uang Tabungan</p><p id="total-tabungan" class="text-2xl font-bold text-gray-800">Memuat...</p></div>
                    <div class="bg-green-100 p-3 rounded-full"><svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div><p class="text-sm font-medium text-gray-500">Jumlah Siswa</p><p id="total-siswa" class="text-2xl font-bold text-gray-800">Memuat...</p></div>
                    <div class="bg-yellow-100 p-3 rounded-full"><svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.125-1.274-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.125-1.274.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div><p class="text-sm font-medium text-gray-500">Jumlah Piala</p><p id="total-piala" class="text-2xl font-bold text-gray-800">Memuat...</p></div>
                    <div class="bg-red-100 p-3 rounded-full"><svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-12v16a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V17z"></path></svg></div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mt-8">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6" id="tab-buttons">
                        <button class="py-4 px-1 border-b-2 font-medium text-sm tab-active" data-tab="uang-kas">Uang Kas</button>
                        <button class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm" data-tab="uang-tabungan">Uang Tabungan</button>
                        <button class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm" data-tab="siswa">Siswa</button>
                    </nav>
                </div>
                <div id="tab-contents" class="mt-6">
                    <div id="uang-kas" class="tab-content">
                        <div class="flex justify-end items-center mb-4">
                            <label class="text-sm font-medium text-gray-700 mr-2">Rentang Tanggal:</label>
                            <input type="date" id="kas-startdate" class="p-2 border border-gray-300 rounded-md text-sm">
                            <span class="mx-2 text-gray-500">-</span>
                            <input type="date" id="kas-enddate" class="p-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        <div class="h-80 w-full relative">
                            <canvas id="kasChart"></canvas>
                            <div id="kas-blank-state" class="absolute inset-0 flex items-center justify-center h-full bg-gray-50 rounded-md hidden"><p class="text-gray-500">Belum ada data</p></div>
                        </div>
                    </div>
                    <div id="uang-tabungan" class="tab-content hidden">
                        <div class="flex justify-end items-center mb-4">
                             <label class="text-sm font-medium text-gray-700 mr-2">Rentang Tanggal:</label>
                             <input type="date" id="tabungan-startdate" class="p-2 border border-gray-300 rounded-md text-sm">
                             <span class="mx-2 text-gray-500">-</span>
                             <input type="date" id="tabungan-enddate" class="p-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        <div class="h-80 w-full relative">
                             <canvas id="tabunganChart"></canvas>
                             <div id="tabungan-blank-state" class="absolute inset-0 flex items-center justify-center h-full bg-gray-50 rounded-md hidden"><p class="text-gray-500">Belum ada data</p></div>
                        </div>
                    </div>
                    <div id="siswa" class="tab-content hidden">
                        <div id="siswa-list-container" class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50"><tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><th class="px-6 py-3">Nama</th><th class="px-6 py-3">Kelas</th><th class="px-6 py-3">Status</th></tr></thead>
                                <tbody id="siswa-list-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <div id="siswa-blank-state" class="flex items-center justify-center h-80 bg-gray-50 rounded-md hidden"><p class="text-gray-500">Belum ada data</p></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 2. Skrip khusus untuk halaman dashboard -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzcjowpZK5bRM2g5VQ77iG3KmYP6ff9u2eV8CJQOxwB3LuxeBOYHEXrcY738IQ3AVmC/exec';

            const userData = JSON.parse(localStorage.getItem('userData'));
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }

            let fullData = {};
            let kasChartInstance, tabunganChartInstance;

            async function fetchData() {
                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        redirect: 'follow',
                        body: JSON.stringify({ action: 'getDashboardData' }),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    if (data.status !== 'success') throw new Error(data.message);

                    fullData = data;
                    updateUI(data);

                } catch (error) {
                    console.error('Gagal mengambil data:', error);
                    showError();
                }
            }

            function updateUI(data) {
                updateInfoCards(data.summary);
                initializeTabs();
                renderKasChart(data.kas || []);
                renderTabunganChart(data.tabungan || []);
                renderSiswaList(data.siswa || []);
            }

            function updateInfoCards(summary) {
                const formatCurrency = (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);
                document.getElementById('total-kas').textContent = formatCurrency(summary.totalKas);
                document.getElementById('total-tabungan').textContent = formatCurrency(summary.totalTabungan);
                document.getElementById('total-siswa').textContent = summary.totalSiswa;
                document.getElementById('total-piala').textContent = summary.totalPiala;
            }

            function initializeTabs() {
                const tabButtons = document.querySelectorAll('#tab-buttons button');
                const tabContents = document.querySelectorAll('#tab-contents .tab-content');
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        tabButtons.forEach(btn => {
                            btn.classList.remove('tab-active');
                            btn.classList.add('text-gray-500', 'border-transparent');
                        });
                        tabContents.forEach(content => content.classList.add('hidden'));
                        
                        button.classList.add('tab-active');
                        button.classList.remove('text-gray-500', 'border-transparent');
                        document.getElementById(button.dataset.tab).classList.remove('hidden');
                    });
                });
            }

            function renderKasChart(kasData) {
                const startDate = document.getElementById('kas-startdate').value;
                const endDate = document.getElementById('kas-enddate').value;
                
                const filteredData = kasData.filter(item => {
                    if (!item.tanggal) return false;
                    const itemDate = new Date(item.tanggal);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;
                    if (start && itemDate < start) return false;
                    if (end && itemDate > end) return false;
                    return true;
                });

                const canvas = document.getElementById('kasChart');
                const blankState = document.getElementById('kas-blank-state');
                
                if (kasChartInstance) kasChartInstance.destroy();

                if (filteredData.length === 0) {
                    canvas.style.display = 'none';
                    blankState.classList.remove('hidden');
                    return;
                }
                canvas.style.display = 'block';
                blankState.classList.add('hidden');

                kasChartInstance = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: filteredData.map(d => new Date(d.tanggal).toLocaleDateString('id-ID')),
                        datasets: [{
                            label: 'Uang Kas',
                            data: filteredData.map(d => d.jumlah),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            function renderTabunganChart(tabunganData) {
                const startDate = document.getElementById('tabungan-startdate').value;
                const endDate = document.getElementById('tabungan-enddate').value;

                const filteredData = tabunganData.filter(item => {
                    if (!item.tanggal) return false;
                    const itemDate = new Date(item.tanggal);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;
                    if (start && itemDate < start) return false;
                    if (end && itemDate > end) return false;
                    return true;
                });

                const canvas = document.getElementById('tabunganChart');
                const blankState = document.getElementById('tabungan-blank-state');

                if (tabunganChartInstance) tabunganChartInstance.destroy();

                if (filteredData.length === 0) {
                    canvas.style.display = 'none';
                    blankState.classList.remove('hidden');
                    return;
                }
                canvas.style.display = 'block';
                blankState.classList.add('hidden');

                tabunganChartInstance = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: filteredData.map(d => new Date(d.tanggal).toLocaleDateString('id-ID')),
                        datasets: [{
                            label: 'Uang Tabungan',
                            data: filteredData.map(d => d.jumlah),
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            function renderSiswaList(siswaData) {
                const listBody = document.getElementById('siswa-list-body');
                const listContainer = document.getElementById('siswa-list-container');
                const blankState = document.getElementById('siswa-blank-state');
                listBody.innerHTML = '';

                if (!siswaData || siswaData.length === 0) {
                    listContainer.classList.add('hidden');
                    blankState.classList.remove('hidden');
                    return;
                }
                listContainer.classList.remove('hidden');
                blankState.classList.add('hidden');

                siswaData.forEach(siswa => {
                    const row = `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${siswa.nama_siswa || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${siswa.kelas || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">${siswa.status || 'Aktif'}</span></td>
                        </tr>
                    `;
                    listBody.innerHTML += row;
                });
            }

            function showError() {
                ['total-kas', 'total-tabungan', 'total-siswa', 'total-piala'].forEach(id => {
                    document.getElementById(id).textContent = 'Error';
                });
            }
            
            document.getElementById('kas-startdate').addEventListener('change', () => renderKasChart(fullData.kas || []));
            document.getElementById('kas-enddate').addEventListener('change', () => renderKasChart(fullData.kas || []));
            document.getElementById('tabungan-startdate').addEventListener('change', () => renderTabunganChart(fullData.tabungan || []));
            document.getElementById('tabungan-enddate').addEventListener('change', () => renderTabunganChart(fullData.tabungan || []));

            fetchData();
        });
    </script>
    
    <!-- 3. Memuat skrip sidebar di bagian akhir -->
    <script src="main.js"></script>
</body>
</html>
