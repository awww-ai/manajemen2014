<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arus Kas - Sistem Informasi SSJ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-100">

<div class="flex h-screen">
    <!-- Sidebar Placeholder -->
    <aside id="sidebar-placeholder" class="w-64 bg-white shadow-md flex flex-col"></aside>

    <main class="flex-1 p-6 sm:p-10 overflow-y-auto">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Arus Kas</h1>
            <button id="add-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Tambah</button>
        </header>

        <!-- Filters -->
        <div class="bg-white p-4 rounded shadow flex flex-wrap gap-4 mb-4">
            <div>
                <label class="text-sm">Jenis Transaksi</label>
                <select id="filter-jenis" class="p-2 border rounded">
                    <option value="semua">Semua</option>
                    <option value="Pemasukan">Pemasukan</option>
                    <option value="Pengeluaran">Pengeluaran</option>
                </select>
            </div>
            <div id="filter-sumber-container" class="hidden">
                <label class="text-sm">Sumber Pemasukan</label>
                <select id="filter-sumber" class="p-2 border rounded">
                    <option value="semua">Semua</option>
                    <option value="Iuran Siswa">Iuran Siswa</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>
            <div id="filter-siswa-container" class="hidden">
                <label class="text-sm">Nama Siswa</label>
                <select id="filter-siswa" class="p-2 border rounded"></select>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-4 border-b">
            <nav class="flex space-x-4">
                <button id="tab-tabel" class="px-4 py-2 border-b-2 border-blue-600 text-blue-600">Tabel</button>
                <button id="tab-chart" class="px-4 py-2 text-gray-500 hover:text-gray-700">Grafik</button>
            </nav>
        </div>

        <!-- Table View -->
        <div id="content-tabel">
            <div class="overflow-x-auto bg-white rounded shadow">
                <table class="min-w-full divide-y">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">Jenis</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="kas-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Chart View -->
        <div id="content-chart" class="hidden">
            <div class="bg-white p-6 rounded shadow">
                <canvas id="kasChart" class="h-96"></canvas>
            </div>
        </div>
    </main>
</div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-6 rounded shadow w-full max-w-md">
        <h2 id="modal-title" class="text-lg font-semibold mb-4">Tambah Transaksi</h2>
        <form id="form">
            <input type="hidden" id="transaksi_id">
            <div class="mb-2">
                <label>Tanggal</label>
                <input type="date" id="tanggal" class="p-2 border rounded w-full" required>
            </div>
            <div class="mb-2">
                <label>Jenis Transaksi</label>
                <select id="jenis" class="p-2 border rounded w-full">
                    <option value="Pemasukan">Pemasukan</option>
                    <option value="Pengeluaran">Pengeluaran</option>
                </select>
            </div>
            <div class="mb-2 hidden" id="modal-sumber-container">
                <label>Sumber Pemasukan</label>
                <select id="modal-sumber" class="p-2 border rounded w-full">
                    <option value="Iuran Siswa">Iuran Siswa</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>
            <div class="mb-2 hidden" id="modal-siswa-container">
                <label>Nama Siswa</label>
                <input type="text" id="modal-siswa" list="datalist-siswa" class="p-2 border rounded w-full">
                <datalist id="datalist-siswa"></datalist>
            </div>
            <div class="mb-2">
                <label>Keterangan</label>
                <input type="text" id="keterangan" class="p-2 border rounded w-full">
            </div>
            <div class="mb-4">
                <label>Jumlah</label>
                <input type="number" id="jumlah" class="p-2 border rounded w-full" required>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" id="cancel" class="px-4 py-2 border rounded">Batal</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Simpan</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const WEB_APP_URL = 'PASTE_WEB_APP_URL_KAMU';
    let allTransactions = [], allSiswa = [], kasChart;

    const tableBody = document.getElementById('kas-table-body');
    const filterJenis = document.getElementById('filter-jenis');
    const filterSumberContainer = document.getElementById('filter-sumber-container');
    const filterSumber = document.getElementById('filter-sumber');
    const filterSiswaContainer = document.getElementById('filter-siswa-container');
    const filterSiswa = document.getElementById('filter-siswa');

    // Tab events
    document.getElementById('tab-tabel').onclick = () => {
        document.getElementById('content-tabel').classList.remove('hidden');
        document.getElementById('content-chart').classList.add('hidden');
    };
    document.getElementById('tab-chart').onclick = () => {
        document.getElementById('content-tabel').classList.add('hidden');
        document.getElementById('content-chart').classList.remove('hidden');
        renderChart(getFiltered());
    };

    // Filter logic
    filterJenis.onchange = () => {
        if (filterJenis.value === 'Pemasukan') filterSumberContainer.classList.remove('hidden');
        else { filterSumberContainer.classList.add('hidden'); filterSiswaContainer.classList.add('hidden'); }
        updateView();
    };
    filterSumber.onchange = () => {
        if (filterSumber.value === 'Iuran Siswa') filterSiswaContainer.classList.remove('hidden');
        else filterSiswaContainer.classList.add('hidden');
        updateView();
    };
    filterSiswa.onchange = updateView;

    // CRUD modal logic
    const modal = document.getElementById('modal');
    const form = document.getElementById('form');
    const modalTitle = document.getElementById('modal-title');
    const modalSumberContainer = document.getElementById('modal-sumber-container');
    const modalSumber = document.getElementById('modal-sumber');
    const modalSiswaContainer = document.getElementById('modal-siswa-container');
    const modalSiswa = document.getElementById('modal-siswa');

    document.getElementById('add-btn').onclick = () => openModal();
    document.getElementById('cancel').onclick = () => modal.classList.add('hidden');

    document.getElementById('jenis').onchange = toggleModalFields;
    modalSumber.onchange = toggleModalFields;

    function toggleModalFields() {
        const jenis = document.getElementById('jenis').value;
        const sumber = modalSumber.value;
        modalSumberContainer.classList.toggle('hidden', jenis !== 'Pemasukan');
        modalSiswaContainer.classList.toggle('hidden', !(jenis === 'Pemasukan' && sumber === 'Iuran Siswa'));
    }

    function openModal(data = {}) {
        modal.classList.remove('hidden');
        modalTitle.textContent = data.transaksi_kas_id ? 'Edit Transaksi' : 'Tambah Transaksi';
        form.reset();
        document.getElementById('transaksi_id').value = data.transaksi_kas_id || '';
        document.getElementById('tanggal').value = data.tanggal || '';
        document.getElementById('jenis').value = data.jenis_transaksi || 'Pemasukan';
        modalSumber.value = data.sumber_pemasukan || 'Iuran Siswa';
        modalSiswa.value = data.nama_siswa || '';
        document.getElementById('keterangan').value = data.keterangan || '';
        document.getElementById('jumlah').value = data.jumlah || '';
        toggleModalFields();
    }

    form.onsubmit = async e => {
        e.preventDefault();
        const payload = {
            action: form.transaksi_id.value ? 'updateRow' : 'addTransaksiKas',
            sheetName: 'Kas',
            id: form.transaksi_id.value,
            idColumnName: 'transaksi_kas_id',
            data: {
                transaksi_kas_id: form.transaksi_id.value || undefined,
                tanggal: form.tanggal.value,
                jenis_transaksi: form.jenis.value,
                sumber_pemasukan: modalSumber.value || '',
                siswa_id: (modalSiswa.value && allSiswa.find(s => s.nama_siswa === modalSiswa.value)?.siswa_id) || '',
                keterangan: form.keterangan.value,
                jumlah: form.jumlah.value
            }
        };
        await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload), headers: {'Content-Type':'text/plain;charset=utf-8'} });
        modal.classList.add('hidden');
        fetchData();
    };

    window.editTransaksi = id => openModal(allTransactions.find(t => t.transaksi_kas_id === id));
    window.deleteTransaksi = async id => {
        if (!confirm('Hapus transaksi ini?')) return;
        await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteRow', sheetName: 'Kas', id, idColumnName: 'transaksi_kas_id' }), headers: {'Content-Type':'text/plain;charset=utf-8'} });
        fetchData();
    };

    function getFiltered() {
        return allTransactions.filter(t => {
            if (filterJenis.value !== 'semua' && t.jenis_transaksi !== filterJenis.value) return false;
            if (filterJenis.value === 'Pemasukan' && filterSumber.value !== 'semua' && t.sumber_pemasukan !== filterSumber.value) return false;
            if (filterSumber.value === 'Iuran Siswa' && filterSiswa.value !== 'semua' && t.siswa_id !== filterSiswa.value) return false;
            return true;
        });
    }

    function renderTable(data) {
        tableBody.innerHTML = '';
        data.forEach(t => {
            const nama = (t.sumber_pemasukan === 'Iuran Siswa') ? (allSiswa.find(s => s.siswa_id === t.siswa_id)?.nama_siswa || '-') : '-';
            tableBody.innerHTML += `<tr>
                <td class="px-6 py-4">${new Date(t.tanggal).toLocaleDateString('id-ID')}</td>
                <td class="px-6 py-4">${t.keterangan || ''}</td>
                <td class="px-6 py-4">${t.jenis_transaksi}</td>
                <td class="px-6 py-4">${nama}</td>
                <td class="px-6 py-4">Rp ${Number(t.jumlah).toLocaleString('id-ID')}</td>
                <td class="px-6 py-4 text-right">
                    <button onclick="editTransaksi('${t.transaksi_kas_id}')" class="text-blue-600">Edit</button>
                    <button onclick="deleteTransaksi('${t.transaksi_kas_id}')" class="text-red-600 ml-2">Hapus</button>
                </td>
            </tr>`;
        });
    }

    function renderChart(data) {
        if (kasChart) kasChart.destroy();
        const pemasukan = data.filter(t => t.jenis_transaksi === 'Pemasukan').reduce((sum, t) => sum + Number(t.jumlah), 0);
        const pengeluaran = data.filter(t => t.jenis_transaksi === 'Pengeluaran').reduce((sum, t) => sum + Number(t.jumlah), 0);
        kasChart = new Chart(document.getElementById('kasChart'), {
            type: 'bar',
            data: {
                labels: ['Pemasukan', 'Pengeluaran'],
                datasets: [{ data: [pemasukan, pengeluaran], backgroundColor: ['#10b981', '#ef4444'] }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    function updateView() { renderTable(getFiltered()); }

    async function fetchData() {
        const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'getKasPageData' }), headers: {'Content-Type':'text/plain;charset=utf-8'} });
        const data = await res.json();
        allTransactions = data.transactions || [];
        allSiswa = data.siswa || [];
        filterSiswa.innerHTML = '<option value="semua">Semua</option>' + allSiswa.map(s => `<option value="${s.siswa_id}">${s.nama_siswa}</option>`).join('');
        document.getElementById('datalist-siswa').innerHTML = allSiswa.map(s => `<option value="${s.nama_siswa}">`).join('');
        updateView();
    }

    fetchData();
});
</script>
</body>
</html>
