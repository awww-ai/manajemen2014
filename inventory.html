<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory - Sistem Informasi SSJ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Sidebar Placeholder -->
        <aside id="sidebar-placeholder" class="w-64 bg-white shadow-md flex flex-col"></aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 sm:p-10 overflow-y-auto">
            <header class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Inventory</h1>
                <button id="add-item-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                    Tambah Item
                </button>
            </header>

            <!-- Data Table -->
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table id="inventory-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Item</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kondisi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Pembelian</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jadwal Cek Berikutnya</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                 <div id="blank-state" class="text-center py-10 text-gray-500 hidden">
                    Belum ada item di inventory.
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Form -->
    <div id="form-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 mx-4">
            <h3 id="modal-title" class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Tambah Item Baru</h3>
            <form id="item-form">
                <input type="hidden" id="item_id">
                <div class="space-y-4">
                    <div>
                        <label for="nama_item" class="block text-sm font-medium text-gray-700">Nama Item</label>
                        <input type="text" id="nama_item" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="jumlah" class="block text-sm font-medium text-gray-700">Jumlah</label>
                            <input type="number" id="jumlah" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="kondisi" class="block text-sm font-medium text-gray-700">Kondisi</label>
                            <select id="kondisi" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-white">
                                <option value="Baru">Baru</option>
                                <option value="OK">OK</option>
                                <option value="Rusak">Rusak</option>
                                <option value="Habis">Habis</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="tanggal_pembelian" class="block text-sm font-medium text-gray-700">Tanggal Pembelian</label>
                            <input type="date" id="tanggal_pembelian" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="jadwal_cek" class="block text-sm font-medium text-gray-700">Periode Cek</label>
                            <select id="jadwal_cek" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-white">
                                <option value="1">1 Bulan</option>
                                <option value="2">2 Bulan</option>
                                <option value="3">3 Bulan</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-form-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md">Batal</button>
                    <button type="submit" id="save-form-btn" class="py-2 px-4 border border-transparent rounded-md text-white bg-blue-600">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxr2ICo_C96PDnyqOl4-joM2l6Dy8c-wkfZcSIfgZ88_sto-Mx7PUo3_0ISTtD5Omw/exec';
            const userData = JSON.parse(localStorage.getItem('userData'));
            if (!userData) { window.location.href = 'login.html'; return; }

            let allItems = [];

            const table = document.getElementById('inventory-table');
            const tableBody = document.getElementById('inventory-table-body');
            const blankState = document.getElementById('blank-state');
            const formModal = document.getElementById('form-modal');
            const itemForm = document.getElementById('item-form');
            const modalTitle = document.getElementById('modal-title');

            async function fetchData() {
                showLoading();
                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST', redirect: 'follow',
                        body: JSON.stringify({ action: 'getInventoryData' }),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });
                    const data = await response.json();
                    if (data.status !== 'success') throw new Error(data.message);
                    
                    allItems = data.data;
                    renderTable(allItems);
                } catch (error) {
                    showError(error.message);
                }
            }

            function renderTable(itemList) {
                tableBody.innerHTML = '';
                if (!itemList || itemList.length === 0) {
                    showEmpty();
                    return;
                }
                table.classList.remove('hidden');
                blankState.classList.add('hidden');

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const sortedData = itemList.sort((a, b) => new Date(b.tanggal_pembelian) - new Date(a.tanggal_pembelian));

                sortedData.forEach(item => {
                    const tglBeli = new Date(item.tanggal_pembelian);
                    const jadwalCekDate = new Date(new Date(item.tanggal_pembelian).setMonth(tglBeli.getMonth() + parseInt(item.jadwal_cek)));
                    
                    let displayKondisi = item.kondisi;
                    let kondisiClass = '';

                    if (today >= jadwalCekDate && !['Rusak', 'Habis'].includes(item.kondisi)) {
                        displayKondisi = 'Perlu Dicek';
                    }

                    switch(displayKondisi) {
                        case 'Baru': case 'OK': kondisiClass = 'bg-green-100 text-green-800'; break;
                        case 'Perlu Dicek': kondisiClass = 'bg-yellow-100 text-yellow-800 animate-pulse'; break;
                        case 'Rusak': case 'Habis': kondisiClass = 'bg-red-100 text-red-800'; break;
                        default: kondisiClass = 'bg-gray-100 text-gray-800';
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${item.nama_item}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${item.jumlah}</td>
                        <td class="px-6 py-4 text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${kondisiClass}">${displayKondisi}</span></td>
                        <td class="px-6 py-4 text-sm text-gray-500">${new Date(item.tanggal_pembelian).toLocaleDateString('id-ID')}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${jadwalCekDate.toLocaleDateString('id-ID')}</td>
                        <td class="px-6 py-4 text-right text-sm font-medium">
                            <button class="text-indigo-600 hover:text-indigo-900" onclick="window.editItem('${item.item_id}')">Edit</button>
                            <button class="text-red-600 hover:text-red-900 ml-4" onclick="window.deleteItem('${item.item_id}')">Hapus</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            itemForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const saveBtn = document.getElementById('save-form-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Menyimpan...';

                const id = document.getElementById('item_id').value;
                const isUpdate = !!id;

                const formData = {
                    action: isUpdate ? 'updateItem' : 'addItem',
                    sheetName: 'Inventory',
                    id: id,
                    idColumnName: 'item_id',
                    data: {
                        item_id: id,
                        nama_item: document.getElementById('nama_item').value,
                        jumlah: document.getElementById('jumlah').value,
                        kondisi: document.getElementById('kondisi').value,
                        tanggal_pembelian: document.getElementById('tanggal_pembelian').value,
                        jadwal_cek: document.getElementById('jadwal_cek').value
                    }
                };
                if (!isUpdate) delete formData.data.item_id;

                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST', redirect: 'follow',
                        body: JSON.stringify(formData),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });
                    const result = await response.json();
                    alert(result.message);
                    if (result.status === 'success') {
                        closeFormModal();
                        fetchData();
                    }
                } catch (error) {
                    alert('Gagal menyimpan: ' + error.message);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Simpan';
                }
            });

            window.editItem = (id) => {
                const item = allItems.find(i => i.item_id === id);
                if (!item) return;
                
                modalTitle.textContent = 'Edit Item';
                document.getElementById('item_id').value = item.item_id;
                document.getElementById('nama_item').value = item.nama_item;
                document.getElementById('jumlah').value = item.jumlah;
                document.getElementById('tanggal_pembelian').value = new Date(item.tanggal_pembelian).toISOString().split('T')[0];
                document.getElementById('jadwal_cek').value = item.jadwal_cek;
                
                const kondisiSelect = document.getElementById('kondisi');
                kondisiSelect.value = item.kondisi;
                
                const tglBeli = new Date(item.tanggal_pembelian);
                const jadwalCekDate = new Date(new Date(item.tanggal_pembelian).setMonth(tglBeli.getMonth() + parseInt(item.jadwal_cek)));
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (today >= jadwalCekDate && !['Rusak', 'Habis'].includes(item.kondisi)) {
                    kondisiSelect.disabled = false;
                    alert("Item ini sudah melewati jadwal cek. Silakan perbarui kondisinya.");
                } else {
                    kondisiSelect.disabled = true;
                }

                openFormModal();
            };

            window.deleteItem = async (id) => {
                if (confirm('Anda yakin ingin menghapus item ini?')) {
                    try {
                        const response = await fetch(WEB_APP_URL, {
                            method: 'POST', redirect: 'follow',
                            body: JSON.stringify({ action: 'deleteRow', sheetName: 'Inventory', id: id, idColumnName: 'item_id' }),
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                        });
                        const result = await response.json();
                        alert(result.message);
                        if (result.status === 'success') fetchData();
                    } catch (error) {
                        alert('Gagal menghapus: ' + error.message);
                    }
                }
            }

            const openFormModal = () => formModal.classList.remove('hidden');
            const closeFormModal = () => {
                formModal.classList.add('hidden');
                itemForm.reset();
            };

            document.getElementById('add-item-btn').addEventListener('click', () => {
                itemForm.reset();
                document.getElementById('item_id').value = '';
                modalTitle.textContent = 'Tambah Item Baru';
                document.getElementById('kondisi').disabled = false;
                document.getElementById('tanggal_pembelian').value = new Date().toISOString().split('T')[0];
                openFormModal();
            });
            document.getElementById('cancel-form-btn').addEventListener('click', closeFormModal);
            
            const showLoading = () => tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">Memuat data...</td></tr>`;
            const showEmpty = () => {
                table.classList.add('hidden');
                blankState.classList.remove('hidden');
            };
            const showError = (message) => alert('Terjadi kesalahan: ' + message);

            fetchData();
        });
    </script>
    
    <script src="main.js"></script>
</body>
</html>
